name: XSS Security Scan

on:
  workflow_dispatch: {}   # Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ· Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ Actions

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install XSStrike
        run: |
          python3 -m pip install --upgrade pip
          pip install xsstrike

      - name: Run XSStrike
        env:
          BASE_URL: ${{ secrets.XSS_BASE_URL }}
        run: |
          echo "Scanning: $BASE_URL"
          # ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ¿Ğ¸ÑˆĞµĞ¼ Ğ² Ñ„Ğ°Ğ¹Ğ»
          xsstrike -u "$BASE_URL" --crawl -l 2 --timeout 6 --skip-dom \
            | tee xss-report.txt
          # ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ¸Ñ‚Ğ¾Ğ³ (ĞºĞ¾Ğ»-Ğ²Ğ¾ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğ¹ 'Payload'/'Vulnerable')
          grep -E "Payload|Vulnerable|Reflected" -n xss-report.txt || true

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: xsstrike-report
          path: xss-report.txt

      # === Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Telegram (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) ===
      - name: Notify Telegram
        if: always()   # ÑˆĞ»Ñ‘Ğ¼ Ğ² Ğ»ÑĞ±Ğ¾Ğ¼ ÑĞ»ÑƒÑ‡Ğ°Ğµ: success/failure
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$TG_TOKEN" ] || [ -z "$TG_CHAT" ]; then
            echo "Telegram secrets not set, skipping notification."
            exit 0
          fi
          STATUS="${{ job.status }}"
          MSG="ğŸ” XSS Scan: *$STATUS*\nRepo: ${{ github.repository }}\nURL: ${XSS_BASE_URL}\nRun: ${GITHUB_RUN_URL}"
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_CHAT" -d parse_mode=Markdown -d text="$MSG" \
            >/dev/null 2>&1 || true
